---
title: "FBD measurements"
author: "Leah Crowe"
date: 'Mar 2023'
output: pdf_document
bibliography: references.bib
---

```{r setup, include=FALSE}
library(dplyr)
library(lubridate)
library(stringr)
library(readxl)
library(ggplot2)
library(ggpubr)

# Data ----
#add population variable to datasheet
#write code to merge data xlsx from Whalelength

#grabs all alts from altperimage files
path<-"./Images/"

measurement_list <- list.files(path, glob2rx("altperimage*.xlsx"), ignore.case = TRUE, recursive = TRUE)

measurement_files <-
  lapply(measurement_list, function(x)
    read_excel(paste0(path, x)))

measurement_files_filter<-lapply(measurement_files, function(x)
  
  x%>%
    filter(issue == 'N' & !is.na(actual_length))%>%
    distinct(DATE, vlc_filename, ID, actual_length)%>% #avg_length_mean, avg_length_sd)
    mutate(trip = paste0(year(DATE),"_",month(DATE)))%>%
    mutate(trip = str_replace(trip, "_7", "_07"))%>%
    mutate(trip = str_replace(trip, "2023_1", "2023_01"))%>%
    mutate(trip = str_replace(trip, "2023_5", "2023_05"))
  )

measurement_merge <- bind_rows(measurement_files_filter)%>%
    mutate(ID = case_when(
    ID == "noodle" ~ "calibration",
    TRUE ~ ID
  ))

#number measurements
nrow(measurement_merge)

measurement_ID_trip<-measurement_merge%>%
  ungroup()%>%
  dplyr::select(ID, actual_length, trip)%>%
  filter(ID != 'NA')%>%
  group_by(ID, trip)%>%
  mutate(actual_length_mean = mean(as.numeric(actual_length)), #mean of lengths measured using altitude at exact time
         actual_length_sd = sd(as.numeric(actual_length)), #sd of lengths measured using altitude at exact time
         #avg_length_mean = mean(avg_length), #mean of lengths measured using averaged altitude +/- 2 sec from exact time
         #avg_length_sd = sd(avg_length), #sd of lengths measured using averaged altitude +/- 2 sec from exact time
         n = n())%>%
  distinct(ID, actual_length_mean, actual_length_sd, n, trip)%>%
  mutate(actual_length_CV = actual_length_sd/actual_length_mean*100)


#nrow(measurement_ID_trip)
          
# measurement_ID_trip%>%
#   filter(actual_length_sd > 0.1)%>%
#   arrange(actual_length_sd)
# 
measurement_merge%>%
  filter(ID == 'SUNSHINE')
```



```{r demo, include = F}
# life history update ----

source('C:/Users/leahm/OneDrive - University of Otago/Documents/git-otago/Fiordland_reporting/scripts/life_history_ageclass update.R', local = TRUE, verbose = F)$value
#use below when you can write to db again
#lifehist<-dbReadTable(con, "life_history_ageclass")
#this created from life_history_ageclass update.R
lifehist<-lifehist

lifehist%>%
  filter(NAME == "SUNSHINE")
# merge lh with measurements ----

measurements_demo_ind<-measurement_ID_trip%>%
  filter(ID != 'calibration')%>%
  left_join(lifehist, by = c('ID' = 'NAME'))%>%
  mutate(YEAR = case_when(
    as.numeric(str_sub(trip,6,7)) < 9 ~ as.numeric(str_sub(trip,1,4)),
    as.numeric(str_sub(trip,6,7)) >= 9 ~ as.numeric(str_sub(trip,1,4))+1,
  ))%>%
  mutate(month = as.numeric(str_sub(trip,6,7)))%>%
  dplyr::select(trip, YEAR, ID, actual_length_mean, actual_length_sd, n, SEX, BIRTH_YEAR, FIRST_YEAR, ends_with('2022'), ends_with('2023'), POD, month)%>%
  #tidyr::pivot_longer(cols = starts_with("X"), names_to = "AGECLASS_YEAR", values_to = "AGECLASS")%>%
  tidyr::pivot_longer(cols = starts_with("2"), names_to = "AGECLASS_YEAR", values_to = "AGECLASS")%>%
  mutate(AGECLASS_YEAR = str_replace(AGECLASS_YEAR, "X", ""))%>%
  filter(YEAR == AGECLASS_YEAR)%>%
  #dplyr::rename(AGECLASS = ends_with(YEAR))%>%
  mutate(AGECLASS = case_when(
    ID == "SUNSHINE" ~ "C",
    TRUE ~ AGECLASS
  ))

measurements_demo_ind$AGECLASS<-factor(measurements_demo_ind$AGECLASS, levels = c("C","J","S-A","A"))

# only age grouping ----

age_length<-measurements_demo_ind

age_length$BIRTH_YEAR<-as.numeric(age_length$BIRTH_YEAR)
age_length$FIRST_YEAR<-as.numeric(age_length$FIRST_YEAR)
age_length$YEAR<-as.numeric(age_length$YEAR)

age_calc<-age_length%>%
  ungroup()%>%
  mutate(age = case_when(
    !is.na(BIRTH_YEAR) ~ YEAR-BIRTH_YEAR,
    is.na(BIRTH_YEAR) ~ YEAR-FIRST_YEAR
  ))%>%
  filter(!is.na(BIRTH_YEAR))
  # mutate(age = case_when(
  #   is.na(BIRTH_YEAR) ~ paste0(age,"+"),
  #   !is.na(BIRTH_YEAR) ~ as.character(age)
  # ))

```

```{r age_length, echo = F, message = F}

#ggplot(age_calc, aes(x = age, y = log(actual_length_mean)))+
  #geom_point()+
  #geom_smooth(se = FALSE, method = "gam", formula = y ~ s(x, bs = "cs"))

# length per age per trip ----
length_trip<-ggplot(age_calc, aes(x = age, y = actual_length_mean, color = POD))+
  geom_point()+
  geom_errorbar(aes(ymin=actual_length_mean-actual_length_sd, ymax=actual_length_mean+actual_length_sd), alpha = 0.5)+
  facet_wrap(~trip)+
  theme_bw()+
  theme(legend.position = "bottom")+
  xlab("Age")+
  ylab("Length (m)")

age_calc%>%distinct(ID, POD)%>%group_by(POD)%>%tally()

ggsave("./Figures/length_trip.png", length_trip, dpi = 320, height = 100, units = 'mm')

age_calc%>%filter(n>1)%>%mutate(CV = actual_length_sd/actual_length_mean)%>%group_by(trip)%>%summarise(min = min(CV),max=max(CV), mean_CV=mean(CV), n = n())

# Individuals that have been measured on more than one trip ----
ID_age<-age_calc%>%
  group_by(ID)%>%
  mutate(n = n())%>%
  filter(n > 1)%>%
  arrange(ID,trip)%>%
  mutate(length_diff = lead(actual_length_mean) - actual_length_mean)
  
ggplot(ID_age, aes(x = trip, y = actual_length_mean, color = SEX))+
  geom_point()+
  geom_errorbar(aes(ymin=actual_length_mean-actual_length_sd, ymax=actual_length_mean+actual_length_sd))+
  facet_wrap(~ID)+
  theme(legend.position = "bottom")

# one measurement for each individual for each of its ages ----
age_calc_year_mean<-age_calc%>%
  group_by(ID, YEAR)%>%
  mutate(actual_length_mean_mean = mean(as.numeric(actual_length_mean)), #mean of lengths measured using altitude at exact time
         actual_length_mean_sd = sd(as.numeric(actual_length_mean)), #sd of lengths measured using altitude at exact time
         n = n())%>%
  distinct(ID, age, n, SEX, BIRTH_YEAR, FIRST_YEAR, POD, YEAR, actual_length_mean_mean, actual_length_mean_sd)  

ggplot(age_calc_year_mean, aes(x = age, y = actual_length_mean_mean, color = POD))+
  #geom_errorbar(aes(ymin=actual_length_mean_mean-actual_length_mean_sd, ymax=actual_length_mean_mean+actual_length_mean_sd))+
  geom_point()+
  geom_line(aes(group = ID))+
  #geom_smooth()+
  theme(legend.position = "bottom")+
  xlab("Age")+
  ylab("Mean length per individual (m)")

# age_calc_month<-age_calc%>%
#   mutate(age = case_when(
#     month == 9 ~ age + 0,
#     month == 10 ~ age + 1/12,
#     month == 11 ~ age + 2/12,
#     month == 12 ~ age + 3/12,
#     month == 1 ~ age + 4/12,
#     month == 2 ~ age + 5/12,
#     month == 3 ~ age + 6/12,
#     month == 4 ~ age + 7/12,
#     month == 5 ~ age + 8/12,
#     month == 6 ~ age + 9/12,
#     month == 7 ~ age + 10/12,
#     month == 8 ~ age + 11/12,
#   ))


## length per year age
mean_year_age<-ggplot(age_calc_year_mean, aes(x = age, y = actual_length_mean_mean))+
  geom_point()+
  geom_line(aes(group = ID))+
  #geom_smooth()+
  theme(legend.position = "bottom")+
  xlab("Age")+
  ylab("Mean length (m)")+
  theme_bw()

##
mean_year_age_scotland<-ggplot()+
  geom_point(data = age_calc_year_mean, mapping = aes(x = age, y = actual_length_mean_mean))+
  #geom_smooth()+
  theme(legend.position = "bottom")+
  theme_bw()+
  xlab("Age")+
  ylab("Mean length (m)")+
  geom_vline(xintercept = c(1,3,5,9), color = "orange")+
  geom_point(mapping = aes(x=c(0.5,2,4,7,20), y=c(1.39,2.43,2.75,2.86,3.06)), color = "orange", size = 3, shape = 17)

#age_calc_month%>%filter(ID == 'SPLASH')

ggsave("./Figures/mean_year_age.png", mean_year_age, dpi = 320, height = 100, units = 'mm')
ggsave("./Figures/mean_year_age_scotland.png", mean_year_age_scotland, dpi = 320, height = 100, units = 'mm')

#growth/shrinking
age_calc_year_mean%>%
  arrange(ID, age)%>%
  group_by(ID)%>%
  mutate(growth = lead(actual_length_mean_mean)-actual_length_mean_mean)%>%
  filter(!is.na(growth))%>%
  arrange(age)
```

Fig. 2: Each point represents the mean total length of an individual at its age for animals whose birth year is known.

```{r summary_stats_ageclass, include = F}
age_length%>%
  group_by(trip, AGECLASS)%>%
  mutate(actual_length_mean_agg = mean(actual_length_mean), #mean of lengths measured using altitude at exact time
         actual_length_sd_agg = sd(actual_length_mean), #sd of lengths measured using altitude at exact time
         actual_length_range = paste0(round(min(actual_length_mean),2),'â€“',round(max(actual_length_mean), 2)),
         num_ind = n())%>%
  distinct(trip, AGECLASS, actual_length_mean_agg, actual_length_sd_agg, actual_length_range, num_ind)
```

```{r ageclass_boxplots, echo = F}

ageclass_length_peryear<-age_length%>%
  filter(!is.na(AGECLASS))%>%
  group_by(ID, YEAR)%>%
  mutate(actual_length_mean_mean = mean(as.numeric(actual_length_mean), na.rm = T), #mean of lengths measured using altitude at exact time
         actual_length_mean_sd = sd(as.numeric(actual_length_mean), na.rm = T), #sd of lengths measured using altitude at exact time
         n = n())%>%
  distinct(ID, AGECLASS, n, SEX, BIRTH_YEAR, FIRST_YEAR, POD, YEAR, actual_length_mean_mean, actual_length_mean_sd) 


ageclass<-ggplot(ageclass_length_peryear, aes(x=AGECLASS, y=actual_length_mean_mean))+
  geom_boxplot(aes(fill = AGECLASS), color = "black", alpha = 0.5)+
  #geom_boxplot(aes(x=AGECLASS, y = actual_length_mean_mean, color = POD, fill = POD), alpha = 0.5, varwidth = T)+
  theme(legend.position = "bottom")+
  xlab("Age class")+
  ylab("Length (m)")+
  theme_bw()+
  scale_fill_viridis_d()

```

Fig. 3: Summary of total lengths (m) per age-class. C = calf of the year, J = 1-2 y, S-A = 3-8, A = 9+.

```{r agesex_boxplots, echo = F}

sex<-ggplot(ageclass_length_peryear, aes(x=AGECLASS, y=actual_length_mean_mean))+
  geom_boxplot(aes(fill = AGECLASS),color = "black", alpha = 0.5)+
  #geom_boxplot(aes(x=AGECLASS, y=actual_length_mean_mean, color = POD, fill = POD), alpha = 0.5, varwidth = T)+
  facet_wrap(~SEX)+
  theme(legend.position = "bottom")+
  xlab("Age class")+
  ylab("")+
  theme_bw()+
  scale_fill_viridis_d()

ageclass_length_peryear%>%
  filter(actual_length_mean_mean > 3)

ageclass_length_peryear%>%
  ungroup()%>%
  distinct(ID, SEX, POD)%>%
  group_by(SEX, POD)%>%
  filter(SEX == "X")%>%
   tally()
# 
# agesex_length_peryear%>%
#   filter(ID == "COMET")


box_plot<-ggpubr::ggarrange(ageclass,sex, common.legend = T, widths = c(0.3, 0.7), legend = "bottom")

ggsave("./Figures/box_plot.png", box_plot, dpi = 320, height = 100, width = 250, units = 'mm')

```

Fig. 4: Summary of total lengths (m) per sex and age-class. C = calf of the year, J = 1-2 y, S-A = 3-8, A = 9+. F = female, M = male, X = unknown.

```{r, stats}

ageclass_length_peryear%>%
  filter(actual_length_mean_mean>3)%>%
  arrange(actual_length_mean_mean)


measurement_ID_trip%>%
  filter(ID == 'MENTRY')

```
```{r, whalength_file_merge}

source('./whalength_file_merge.R', local = TRUE, verbose = F)$value

```

```{r measure_per_individual, echo = F}

# sluething suspect measurements
ggplot(length_ID_merge_Tt)+
  geom_point(aes(x = actual_length_mean_mean, y = actual_length_mean_sd))

hist<-ggplot(length_ID_merge_Tt%>%group_by(ID,trip)%>%tally())+
  geom_histogram(aes(x = n), binwidth = 1, color = "black")+
  facet_wrap(~trip)+
  ylab("Number of individuals")+
  xlab("Number of photographs measured")+
  theme_bw()

hist

length_ID_merge_Tt%>%
  filter(is.na(actual_length))

ggsave("./Figures/hist.png", hist, dpi = 320, height = 75, units = 'mm')

length_ID_merge_Tt%>%ungroup()%>%distinct(ID, POD)%>%filter(!is.na(POD))%>%group_by(POD)%>%tally()

```

Fig. 1: number of times individuals were measured per trip
